version: '3.7'

services:
    # MQTT Broker
    mosquitto:
        image: eclipse-mosquitto
        # build: mosquitto/
        restart: always
        volumes:
            - ./mosquitto:/mosquitto
        ports:
            - "1883:1883"
            - "9001:9001"

    # Datenbank
    # Use root/example as user/password credentials
    db:
        image: mariadb
        restart: always
        environment:
            MYSQL_ROOT_PASSWORD: example
            MYSQL_DATABASE: mysql
            MYSQL_USER: mqtt
            MYSQL_PASSWORD: smart-security
        volumes:
            - dbdata:/var/lib/mysql
            # - ./mariadb/conf/config-file.cnf:/etc/mysql/conf.d/config-file.cnf:ro
        ports:
            - "3306:3306"

    # db:
    #     image: mysql
    #     # command: --default-authentication-plugin=mysql_native_password
    #     restart: always
    #     environment:
    #         MYSQL_ROOT_PASSWORD: example
    #     # volumes:
    #     #     - ./mariadb/conf:/etc/mysql/conf.d # wird ignoriert https://stackoverflow.com/questions/53741107/mysql-in-docker-on-ubuntu-warning-world-writable-config-file-is-ignored
    #     ports:
    #         - "3306:3306"
    

    # Datenbank Web-Administration
    adminer:
        image: adminer
        restart: always
        ports:
        - 8080:8080

    mqtt2mysql:
        image: davidlor/python-autoclonable-app
        depends_on: 
            - db
        environment: 
            - GIT_REPOSITORY=https://github.com/David-Lor/MQTT2MySQL.git
            - GIT_BRANCH=master
            - APP_NAME=MQTT2MySQL
            - MQTT_BROKER=mosquitto
            - MQTT_PORT=1883
            - MQTT_KEEPAPIVE=60
            - MQTT_QOS=2
            - SQL_USER=mqtt
            - SQL_PASSWORD=smart-security
            - SQL_DATABASE=mqtt
            - SQL_HOST=db
            - SQL_PORT=3306


volumes:
    dbdata: